<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Форма для бота</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Стили остаются такими же как в предыдущем примере */
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 100%; background: white; padding: 20px; border-radius: 10px; }
        /* ... остальные стили ... */
    </style>
</head>
<body>
    <div class="container">
        <h1>Форма обратной связи</h1>
        
        <div id="debug-console" style="border:1px solid red; padding:10px; margin-bottom:20px;">
            <h3>Консоль отладки:</h3>
            <div id="debug-output"></div>
        </div>
        
        <div id="form-container">
            <form id="feedback-form">
                <input type="text" id="name" placeholder="Ваше имя" required>
                <input type="email" id="email" placeholder="Ваш Email" required>
                <textarea id="message" placeholder="Ваше сообщение" required></textarea>
                <button type="submit">Отправить</button>
            </form>
        </div>
        
        <div id="success-container" class="hidden">
            <h2>✅ Данные отправлены!</h2>
            <p>Окно закроется автоматически...</p>
        </div>
    </div>

    <script>
        // Расширенная система диагностики
        const debug = (message) => {
            const debugOutput = document.getElementById('debug-output');
            debugOutput.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${message}</div>`;
            console.log(message);
        };

        // Инициализация WebApp
        try {
            if (!window.Telegram?.WebApp) {
                throw new Error('Telegram WebApp API не загружен');
            }

            const tg = Telegram.WebApp;
            tg.expand();
            tg.enableClosingConfirmation();

            debug(`WebApp инициализирован. Версия: ${tg.version}, Платформа: ${tg.platform}`);
            debug(`User ID: ${tg.initDataUnsafe?.user?.id}`);

            // Проверка методов API
            debug(`sendData available: ${typeof tg.sendData === 'function'}`);
            debug(`postEvent available: ${typeof tg.postEvent === 'function'}`);

            // Функция отправки данных
            const sendDataToBot = async (data) => {
                const sendMethods = [];
                
                // Метод 1: Основной способ
                if (typeof tg.sendData === 'function') {
                    sendMethods.push(() => {
                        tg.sendData(JSON.stringify(data));
                        debug('Данные отправлены через sendData');
                        return true;
                    });
                }

                // Метод 2: Для десктопной версии
                sendMethods.push(async () => {
                    try {
                        const response = await fetch(
                            'https://api.telegram.org/bot8029087587:AAFgw827hRvzNtmakLBtfNZx1ZJTd4vRY3Q/sendMessage',
                            {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    chat_id: tg.initDataUnsafe?.user?.id,
                                    text: `Данные формы:\n${JSON.stringify(data, null, 2)}`,
                                    disable_web_page_preview: true
                                })
                            }
                        );
                        debug(`Резервная отправка через API: ${response.status}`);
                        return true;
                    } catch (e) {
                        debug(`Ошибка резервной отправки: ${e.message}`);
                        return false;
                    }
                });

                // Метод 3: Deep link для десктопа
                sendMethods.push(() => {
                    if (tg.platform === 'tdesktop' && tg.initDataUnsafe?.user?.username) {
                        window.open(`https://t.me/${tg.initDataUnsafe.user.username}?start=webapp_${encodeURIComponent(JSON.stringify(data))}`, '_blank');
                        debug('Использован deep link для десктопа');
                        return true;
                    }
                    return false;
                });

                // Пробуем все методы по очереди
                for (const method of sendMethods) {
                    try {
                        if (await method()) return true;
                    } catch (e) {
                        debug(`Ошибка метода отправки: ${e.message}`);
                    }
                }
                
                return false;
            };

            // Обработка формы
            document.getElementById('feedback-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    message: document.getElementById('message').value,
                    platform: tg.platform,
                    version: tg.version,
                    timestamp: Date.now()
                };

                debug(`Попытка отправки данных: ${JSON.stringify(formData)}`);

                const success = await sendDataToBot(formData);

                if (success) {
                    document.getElementById('form-container').style.display = 'none';
                    document.getElementById('success-container').style.display = 'block';
                    setTimeout(() => tg.close(), 2000);
                } else {
                    alert('Не удалось отправить данные. Пожалуйста, попробуйте позже.');
                }
            });

        } catch (e) {
            debug(`Критическая ошибка инициализации: ${e.message}`);
            document.getElementById('debug-console').style.backgroundColor = '#ffdddd';
        }
    </script>
</body>
</html>
